<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><title> Github Actions 测试 - 自动部署 Hexo · xiaopc</title><meta name="description" content="Github Actions 测试 - 自动部署 Hexo - xiaopc"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://xiaopc.org/atom.xml" title="xiaopc"><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="xiaopc" type="application/atom+xml">
</head><body><div class="wrap"><header><a class="logo-link" href="/"><img src="/logo.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">home</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self">archives</a></li><li class="nav-list-item"><a class="nav-list-link" href="/links/" target="_self">links</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://xpc.im/" target="_blank">about</a></li><li class="nav-list-item"><a class="nav-list-link" href="/blog-en/" target="_self">en</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Github Actions 测试 - 自动部署 Hexo</h1><div class="post-info">2019年8月29日 · <a href="/categories/devops/">devops</a></div><div class="post-content"><p>终于，Github 自己出 CI/CD 工具了，Whoa~</p>
<p><img src="/images/github-actions.png" /></p>
<p>鉴于 Gitlab 等早就有自动构建工具了，Github 已经晚了许多，那 Github Actions 能打得过吗？来上手试一下。</p>
<span id="more"></span>
<h2 id="为什么是自动部署-hexo">0. 为什么是自动部署 Hexo</h2>
<p>个人项目很少会用到 CI/CD 工具，那几乎唯一能用到自动部署的就是静态博客了。</p>
<p>而且折腾 Blog 是咱最喜欢的娱乐活动之一...<del>（写 Blog 不是）</del></p>
<h2 id="get-started">1. Get started</h2>
<p>先在 <a target="_blank" rel="noopener" href="https://github.com/features/actions">GitHub Actions</a> 申请测试，然后等邮件通知。</p>
<p>咱等了不到一周的样子就收到了开通邮件。</p>
<p>当然，如果是体验 CI 的话，也可以选择其他的工具，比如 Travis CI。 这是之前写的介绍：<a href="https://xiaopc.org/2018/04/28/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E4%B8%8E-travis-ci-%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5/">持续集成与 Travis CI 入门实践</a>，这篇结尾有个链接介绍如何部署 Hexo 的，可以参考。</p>
<h2 id="配置-hexo">2. 配置 Hexo</h2>
<p>如何安装及配置 Hexo 不是本文重点，请自行查询<a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/">官方文档</a>。</p>
<p>建议先在本地跑通部署到 Github Pages 以后再继续。</p>
<p>配置完成后，把 <code>_config.yml</code> 里 <code>deploy</code> 的 repo 地址换成 SSH 地址（仓库页面 <strong>Clone and Download - Use SSH</strong> 里的地址），以便后面用密钥 push 到仓库。</p>
<h2 id="配置仓库及-key">3. 配置仓库及 key</h2>
<p>因为用户名 <code>username.github.io</code> 的 Github Pages 仓库只能部署 master 分支，而 Actions 的配置文件需要放在 master 分支（仅为个人猜测，因为放在其他分支出现了问题）。 所以需要再开一个仓库，放本地的源代码以及配置 Actions。</p>
<blockquote>
<p>2020-06-06 update: 若不使用 <code>username.github.io</code> 这个仓库，而是在其他名字的仓库使用 Pages 的话，是可以放在同一个仓库的不同分支上的。 Actions 配置文件仅在当前分支上会被触发（<a target="_blank" rel="noopener" href="https://help.github.com/en/actions/reference/events-that-trigger-workflows#about-workflow-events">source</a>），因此开一个分支 <code>source</code> 里面放源码和 Actions 配置文件是可以的 。详见<a target="_blank" rel="noopener" href="https://github.com/xiaopc/blog-en">英文版 Blog</a> 的操作。</p>
</blockquote>
<p>新建一个仓库，先不需要初始化。在本地生成一个 key：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -b 4096 -C <span class="string">&quot;xiaopc@users.noreply.github.com&quot;</span> -f ~/.ssh/github-actions-deploy</span><br></pre></td></tr></table></figure>
<p>（也可以生成其他种类的 key，如果用上面的命令，需要修改一下用户名）</p>
<p>在新仓库的 <strong>Settings -&gt; Secrets</strong> 里添加刚刚生成的私钥，名称为 <code>ACTION_DEPLOY_KEY</code>。</p>
<p>然后在 Github Pages 的仓库，<strong>Settings -&gt; Deploy keys</strong> 添加刚刚生成的公钥，名称随意，但要勾选 <strong>Allow write access</strong>。</p>
<blockquote>
<p>2020-02-19 update: 如果 Github 账号有添加过 SSH key 是可以直接用的（那个 key 有所有仓库的权限），只需要添加 <code>ACTION_DEPLOY_KEY</code> 即可，不需要添加公钥。 但是为了安全起见呢，最好还是新建一个吧 (o=^•ェ•)o</p>
</blockquote>
<blockquote>
<p>2020-06-06 update: 同一个 Github 账号下不能添加两个相同的 SSH key，也就是说按照上面的方法添加的 key 无法再被添加到另外一个仓库，或是设为账号全局 key。</p>
</blockquote>
<h2 id="给源码仓库添加-actions-配置">4. 给源码仓库添加 Actions 配置</h2>
<p>可以在网页上 <strong>Actions</strong> 里编辑配置文件，也可以直接在本地目录添加直接 commit。</p>
<p>网页上可以看到，Github 提供了很多的模板：</p>
<p><img src="/images/github-actions-template.png" /></p>
<p>对于大部分应用的自动测试构建发布是足够的了，这个相比 Travis CI 降低了一点点门槛。</p>
<p>此外，Actions 还可以将动作打包发布到 <a target="_blank" rel="noopener" href="https://github.com/marketplace?type=actions">Marketplace</a>，这是 Actions 的一个亮点，大大增加了复用能力。</p>
<p>不过要部署 Hexo，现在还没有打包的动作，需要自己写。</p>
<p>如果在网页编辑配置文件的话，选择 <code>Blank workflow</code>。 如果是在本地目录提交配置文件的话，将配置文件存至 <code>.github/workflows/*随便起名*.yml</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Build</span> <span class="string">and</span> <span class="string">Update</span> <span class="string">Github</span> <span class="string">Pages</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span> <span class="string">push</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v1</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Use</span> <span class="string">Node.js</span> <span class="number">10.</span><span class="string">x</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-node@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">node-version:</span> <span class="string">&quot;10.x&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Setup</span> <span class="string">Hexo</span> <span class="string">env</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">ACTION_DEPLOY_KEY:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.ACTION_DEPLOY_KEY</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          # set up private key for deploy</span></span><br><span class="line"><span class="string">          mkdir -p ~/.ssh/</span></span><br><span class="line"><span class="string">          echo &quot;$ACTION_DEPLOY_KEY&quot; | tr -d &#x27;\r&#x27; &gt; ~/.ssh/id_rsa</span></span><br><span class="line"><span class="string">          chmod 600 ~/.ssh/id_rsa</span></span><br><span class="line"><span class="string">          ssh-keyscan github.com &gt;&gt; ~/.ssh/known_hosts</span></span><br><span class="line"><span class="string">          # set git infomation</span></span><br><span class="line"><span class="string">          git config --global user.name &#x27;xiaopc&#x27;</span></span><br><span class="line"><span class="string">          git config --global user.email &#x27;xiaopc@users.noreply.github.com&#x27;</span></span><br><span class="line"><span class="string">          # install dependencies</span></span><br><span class="line"><span class="string">          npm i -g hexo-cli</span></span><br><span class="line"><span class="string">          npm i</span></span><br><span class="line"><span class="string">          # install pandoc</span></span><br><span class="line"><span class="string">          curl -s -L https://github.com/jgm/pandoc/releases/download/2.7.3/pandoc-2.7.3-linux.tar.gz | tar xvzf - -C $RUNNER_TOOL_CACHE/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          # add pandoc to PATH</span></span><br><span class="line"><span class="string">          export PATH=&quot;$PATH:$RUNNER_TOOL_CACHE/pandoc-2.7.3/bin&quot;</span></span><br><span class="line"><span class="string">          # publish</span></span><br><span class="line"><span class="string">          hexo generate &amp;&amp; hexo deploy</span></span><br></pre></td></tr></table></figure>
<p>对这个配置文件做几点说明：</p>
<ol start="0" type="1">
<li><p>Actions 在早期测试时用的是 HCL 格式，而现在使用 YAML 配置，HCL 格式配置文件已被废弃。YAML 格式需要严格按照缩进。</p></li>
<li><p><code>on</code> 标注什么事件会触发这个 workflow，可以指定 branches，详情参考<a target="_blank" rel="noopener" href="https://help.github.com/en/articles/events-that-trigger-workflows">文档</a>。</p></li>
<li><p><code>runs-on</code> 设置运行平台，目前有 Windows、Ubuntu、macOS，见<a target="_blank" rel="noopener" href="https://help.github.com/en/articles/virtual-environments-for-github-actions">文档</a>。</p></li>
<li><p><code>uses</code> 是使用打包好的 action，可以通过 <code>with</code> 传参数。官方提供了一些 Git 基本操作和环境安装的包，也可以使用 Docker。</p></li>
<li><p><code>env</code> 可以设置这一步的环境变量，这一步设置的变量不会继承到下一步。刚才设置的私钥可以通过 <code>secrets</code> 模板变量获取到，具体见<a target="_blank" rel="noopener" href="https://help.github.com/en/articles/virtual-environments-for-github-actions">文档</a>。另外直接将密钥 echo 出来会被打码 :)</p></li>
<li><p>在网页上保存私钥很可能会把 key 存成 CR-LF 换行模式的，而私钥文件要求 LF 模式，要用 <code>tr -d '\r'</code> 去掉回车符。（在这卡了几个小时(ノへ￣、)）[3]</p></li>
<li><p>Git 配置请更改为自己的。</p></li>
<li><p>由于咱用了 hexo-renderer-pandoc 引擎渲染 Markdown（LaTeX 公式支持更好），要装 pandoc。 但是没有 root 权限，只能手动装在其他目录。 官方的 toolkit 提供了一个缓存下载内容的工具 <a target="_blank" rel="noopener" href="https://github.com/actions/toolkit/tree/master/packages/tool-cache">actions/tool-cache</a>，但是它仅在一个 workflow 里作用，so...</p></li>
<li><p>上面说的那个工具下载保存目录是 <code>$RUNNER_TOOL_CACHE</code>，这个环境变量没有在文档里，目前值为 <code>/opt/hostedtoolcache</code>。</p></li>
</ol>
<h2 id="开始构建">5. 开始构建</h2>
<p>配置好了，commit &amp; push 后在网页查看 build 状态：</p>
<p><img src="/images/github-actions-status.png" /></p>
<h2 id="尾声">6. 尾声</h2>
<p>和 Travis CI 相比，Actions 提供的平台更多，扩展性更强，但是缺少像 build cache 这些功能（build 的时候每次都要重新装依赖）。</p>
<p>虽然和它声称的 <strong>word-class CI/CD</strong> 还有一些距离，但是 Actions 已经比目前免费的工具高到不知道哪里了。</p>
<p>再加上它与 Github 的深度集成，以及 marketplace 仓库，可以发挥 CI/CD 的更多潜能。</p>
<p>对了，Actions 公开仓库免费，私仓按运行时间计费。</p>
<hr />
<p>本文参考了：</p>
<p>[1] 通过 GitHub Actions 自动部署 Hexo <a target="_blank" rel="noopener" href="https://gythialy.github.io/deploy-hexo-to-github-pages-via-github-actions/">https://gythialy.github.io/deploy-hexo-to-github-pages-via-github-actions/</a></p>
<p>[2] Deploying Hugo With Github Actions <a target="_blank" rel="noopener" href="https://cupfullofcode.com/blog/2018/12/21/deploying-hugo-with-github-actions/">https://cupfullofcode.com/blog/2018/12/21/deploying-hugo-with-github-actions/</a></p>
<p>[3] .gitlab.ci.yml for SSH with private key <a target="_blank" rel="noopener" href="https://gist.github.com/yannhowe/5ab1501156bd84c8ac261e2c17b8e3e0">https://gist.github.com/yannhowe/5ab1501156bd84c8ac261e2c17b8e3e0</a></p>
</div><div class="post-footer"><p class="license">本文以「<a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-sa/4.0">知识共享 署名—相同方式共享（CC BY-SA 4.0）</a>」发布。<br><br>
允许复制、转贴、演绎本文，<br>
惟需注明本文地址，<br>
并遵循相同许可协议。<br></p><div class="like"><img class="like-qrcode" src="/wechat_like.png" alt="like qrcode"><img class="avatar" src="/avatar.jpg"></div></div></article></div></main><footer><div class="paginator"><a class="prev" href="/2020/02/02/home-assistant-%E8%BF%9E%E6%8E%A5%E7%B1%B3%E5%AE%B6%E8%AE%BE%E5%A4%87/">上一篇</a><a class="next" href="/2019/08/13/backdrop-filter-%E6%9D%A5%E4%BA%86/">下一篇</a></div><div class="copyright"><p>&copy; 2023 <a href="https://xiaopc.org">xiaopc</a>, <a href="https://hexo.io/" target="_blank">hexo</a> & <a href="https://github.com/xiaopc/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdnjs.loli.net/ajax/libs/mathjax/2.7.2-rc/MathJax.js?config=TeX-AMS-MML_HTMLorMML" crossorigin="anonymous"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-KNHBVTCZSN"></script><script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', "G-KNHBVTCZSN");</script></body></html>